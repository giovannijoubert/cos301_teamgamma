<!DOCTYPE html>
<html>
<script type="text/javascript">
console.clear();

  var started = null;
  window.addEventListener('click', () => {
    if (started) return;
    started = true;
    initialize();
  })

  function initialize() {
    document.body.querySelector('h1').style.visibility = 'hidden';
    document.body.querySelector('h2').style.visibility = 'visible';



    const CANVAS = document.body.querySelector('canvas');
    const CANVAS_CONTEXT = CANVAS.getContext('2d');
    const W = CANVAS.width = window.innerWidth;
    const H = CANVAS.height = window.innerHeight;

    const AUDIO_CONTEXT = new AudioContext();
    const ANALYSER = AUDIO_CONTEXT.createAnalyser();

    ANALYSER.fftSize = 4096;


    var audio = document.getElementById("myAudio1");
    audio.play();
    var playableAudio = document.getElementById("myAudio2");
    playableAudio.play();

      const SOURCE = AUDIO_CONTEXT.createMediaElementSource(audio);


      SOURCE.connect(ANALYSER);
      console.log("source");
      const DATA = new Uint8Array(ANALYSER.frequencyBinCount);
      const LEN = DATA.length;
      const h = H / LEN;
      const x = W - 1;
      CANVAS_CONTEXT.fillStyle = 'hsl(280, 100%, 10%)';
      CANVAS_CONTEXT.fillRect(0, 0, W, H);

      //loop for song length
      loop();

      function loop() {
        window.requestAnimationFrame(loop);
        let imgData = CANVAS_CONTEXT.getImageData(1, 0, W - 1, H);
        CANVAS_CONTEXT.fillRect(0, 0, W, H);
        CANVAS_CONTEXT.putImageData(imgData, 0, 0);
        ANALYSER.getByteFrequencyData(DATA);
        for (let i = 0; i < LEN; i++) {
          let rat = DATA[i] / 255;
          let hue = Math.round((rat * 120) + 280 % 360);
          let sat = '100%';
          let lit = 10 + (70 * rat) + '%';
          CANVAS_CONTEXT.beginPath();
          CANVAS_CONTEXT.strokeStyle = `hsl(${hue}, ${sat}, ${lit})`;
          CANVAS_CONTEXT.moveTo(x, H - (i * h));
          CANVAS_CONTEXT.lineTo(x, H - (i * h + h));
          CANVAS_CONTEXT.stroke();
        }
      }

  }
</script>
<style media="screen">
  html, body { height: 100%; }
  canvas {
    display: block;
    height: 100%;
    width: 100%;
  }

  h1 {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0;
  }
  h2 {
    visibility: hidden;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0;
    color: white;
  }

</style>
<head>
<title>Frequency</title>
</head>
<body>

  <h1>Click to start</h1>

  <h2>Frequency</h2>

  <canvas></canvas>

  <audio id = "myAudio1" src="sound.aac">

  </audio>

  <audio id = "myAudio2" src="sound.aac">

  </audio>


</body>
</html>
